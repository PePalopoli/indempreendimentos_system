{% extends 'security/empreendimentos/theme.twig' %}

{% block stylesheet %}
	{{ parent() }}
	<link rel="stylesheet" href="{{ asset('dist/css/adminlte.min.css') }}">
	<!-- Summernote -->
	<link rel="stylesheet" href="{{ asset('plugins/summernote/summernote-bs4.min.css') }}">
	<!-- Select2 -->
	<link rel="stylesheet" href="{{ asset('plugins/select2/css/select2.min.css') }}">
	<link rel="stylesheet" href="{{ asset('plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css') }}">
	
	<style>
		/* Estilos para galeria de imagens */
		.marked-for-removal {
			position: relative;
		}
		
		.marked-for-removal::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: rgba(220, 53, 69, 0.1);
			border: 2px dashed #dc3545;
			border-radius: 0.25rem;
			z-index: 1;
		}
		
		.card-body .text-danger {
			z-index: 2;
			position: relative;
			background-color: rgba(255, 255, 255, 0.9);
			padding: 2px 5px;
			border-radius: 3px;
			margin-top: 5px;
		}
		
		/* Efeito hover para imagens */
		.card img:hover {
			transform: scale(1.02);
			transition: transform 0.2s ease-in-out;
		}
		
		/* Drag and drop area */
		.border-primary.bg-light {
			border-style: dashed !important;
			border-width: 2px !important;
		}
		
		/* Preview container */
		#preview-container {
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			padding: 15px;
			background-color: #f8f9fa;
		}
		
		/* Loading states */
		.btn:disabled {
			opacity: 0.6;
		}
		
		/* Contador de imagens */
		.image-counter {
			background-color: #17a2b8;
			color: white;
			padding: 2px 8px;
			border-radius: 12px;
			font-size: 0.875rem;
			font-weight: bold;
		}
		
		/* Bot√£o de remo√ß√£o de imagem */
		.btn-remove-image {
			opacity: 0.8;
			transition: opacity 0.2s ease-in-out;
			border-radius: 50%;
			width: 30px;
			height: 30px;
			display: flex;
			align-items: center;
			justify-content: center;
			box-shadow: 0 2px 4px rgba(0,0,0,0.3);
		}
		
		.btn-remove-image:hover {
			opacity: 1;
			transform: scale(1.1);
		}
		
		/* Container da imagem com hover */
		.position-relative:hover .btn-remove-image {
			opacity: 1;
		}
		
		/* Badge contador */
		.badge-info {
			background-color: #17a2b8;
		}
	</style>
{% endblock %}

{% block content %}

	{% block form_title %}{% endblock form_title %}

	<!-- Adicionar no in√≠cio do formul√°rio -->
	<div class="alert alert-info">
		<i class="fas fa-info-circle"></i>
		<strong>Limite de upload:</strong>
		Tamanho m√°ximo permitido:
		<?php echo ini_get('upload_max_filesize'); ?>
	</div>

	<!-- Main content -->
	<section class="content">
		<div class="container-fluid">

			{{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

			<div class="row">
				<div
					class="col-md-8">
					<!-- Dados B√°sicos -->
					<div class="card card-info">
						<div class="card-header">
							<h3 class="card-title">Dados B√°sicos do Empreendimento</h3>
							<div class="card-tools">
								<button type="button" class="btn btn-tool" data-card-widget="collapse">
									<i class="fas fa-minus"></i>
								</button>
							</div>
						</div>
						<div class="card-body">
							<div class="row">
								<div class="col-md-6">
									<div class="form-group">
										{{ form_label(form.nome) }}
										{{ form_errors(form.nome) }}
										{{ form_widget(form.nome, { attr: { 'class': 'form-control' }}) }}
									</div>
								</div>

								<div class="col-md-6">
									<div class="form-group">
										{{ form_label(form.cidade_estado) }}
										{{ form_errors(form.cidade_estado) }}
										{{ form_widget(form.cidade_estado, { attr: { 'class': 'form-control' }}) }}
									</div>
								</div>
							</div>

							<div class="row">


								<div class="form-group col-md-6">
									{{ form_label(form.etapa_id) }}
									{{ form_errors(form.etapa_id) }}
									{{ form_widget(form.etapa_id, { attr: { 'class': 'form-control select2' }}) }}
								</div>


								<div class="form-group col-md-6">
									{{ form_label(form.slug) }}
									{{ form_errors(form.slug) }}
									{{ form_widget(form.slug, { attr: { 'class': 'form-control' }}) }}
									<small class="form-text text-muted">URL amig√°vel (ser√° gerada automaticamente se deixar em branco)</small>
								</div>
							</div>

							<div class="form-group">
								{{ form_label(form.descricao) }}
								{{ form_errors(form.descricao) }}
								{{ form_widget(form.descricao, { attr: { 'class': 'form-control editor-content' }}) }}
							</div>
						</div>
					</div>

					<!-- SEO -->
					<div class="card card-secondary">
						<div class="card-header">
							<h3 class="card-title">SEO</h3>
							<div class="card-tools">
								<button type="button" class="btn btn-tool" data-card-widget="collapse">
									<i class="fas fa-minus"></i>
								</button>
							</div>
						</div>
						<div class="card-body">
							<div class="form-group">
								{{ form_label(form.meta_title) }}
								{{ form_errors(form.meta_title) }}
								{{ form_widget(form.meta_title, { attr: { 'class': 'form-control' }}) }}
								<div class="text-muted small">
									<span id="meta-title-count">0</span>/160 caracteres
								</div>
							</div>

							<div class="form-group">
								{{ form_label(form.meta_description) }}
								{{ form_errors(form.meta_description) }}
								{{ form_widget(form.meta_description, { attr: { 'class': 'form-control' }}) }}
								<div class="text-muted small">
									<span id="meta-desc-count">0</span>/255 caracteres
								</div>
							</div>

							<div class="form-group">
								{{ form_label(form.meta_keywords) }}
								{{ form_errors(form.meta_keywords) }}
								{{ form_widget(form.meta_keywords, { attr: { 'class': 'form-control' }}) }}
							</div>
						</div>
					</div>
				</div>

				<div
					class="col-md-4">
					<!-- Status e Configura√ß√µes -->
					<div class="card card-primary">
						<div class="card-header">
							<h3 class="card-title">Status e Configura√ß√µes</h3>
						</div>
						<div class="card-body">
							<div class="form-group">
								{{ form_label(form.enabled) }}
								{{ form_errors(form.enabled) }}
								{{ form_widget(form.enabled, { attr: { 'class': 'form-control select2' }}) }}
							</div>

							<div class="form-group">
								{{ form_label(form.destaque) }}
								<div class="form-check">
									{{ form_widget(form.destaque) }}
									{{ form_label(form.destaque, 'Empreendimento em destaque', {'label_attr': {'class': 'form-check-label'}}) }}
								</div>
							</div>
						</div>
					</div>

					<!-- Imagens -->
					<div class="card card-warning">
						<div class="card-header">
							<h3 class="card-title">Imagens</h3>
						</div>
						<div class="card-body">
							<div class="form-group">
								{{ form_label(form.logo_empreendimento) }}
								{{ form_errors(form.logo_empreendimento) }}
								{{ form_widget(form.logo_empreendimento, { attr: { 'class': 'form-control' }}) }}
								<small class="form-text text-muted">Logo do empreendimento</small>
							</div>

							<div class="form-group">
								{{ form_label(form.img_capa) }}
								{{ form_errors(form.img_capa) }}
								{{ form_widget(form.img_capa, { attr: { 'class': 'form-control' }}) }}
								<small class="form-text text-muted">Imagem principal de capa</small>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- NOVA SE√á√ÉO: GALERIA DE IMAGENS -->
			<div class="card card-info">
				<div class="card-header">
					<h3 class="card-title">
						<i class="fas fa-images"></i>
						Galeria de Imagens
					</h3>
					<div class="card-tools">
						<button type="button" class="btn btn-tool" data-card-widget="collapse">
							<i class="fas fa-minus"></i>
						</button>
					</div>
				</div>
				<div class="card-body">
					<!-- Upload m√∫ltiplo de novas imagens -->
					<div class="form-group">
						{{ form_label(form.galeria_imagens) }}
						{{ form_errors(form.galeria_imagens) }}
						{{ form_widget(form.galeria_imagens, { 
							attr: { 
								'class': 'form-control-file',
								'multiple': true,
								'accept': 'image/*',
								'id': 'galeria_imagens_input'
							}
						}) }}
						<small class="form-text text-muted">
							<i class="fas fa-info-circle"></i>
							<strong>Limites:</strong> M√°ximo 20 arquivos, 10MB cada, 80MB total. Formatos: JPG, PNG, GIF, WEBP
						</small>
					</div>

					<!-- Preview das novas imagens selecionadas -->
					<div id="preview-container" class="mt-3" style="display: none;">
						<h6><i class="fas fa-eye"></i> Pr√©via das novas imagens:</h6>
						<div id="preview-images" class="row"></div>
					</div>

					{% if galeria_existente is defined and galeria_existente|length > 0 %}
					<!-- Galeria existente (apenas na edi√ß√£o) -->
					<div class="mt-4">
						<h6><i class="fas fa-folder-open"></i> Imagens atuais na galeria ({{ galeria_existente|length }}):</h6>
						<div class="row">
							{% for imagem in galeria_existente %}
							<div class="col-md-4 col-sm-6 mb-3" id="galeria-item-{{ imagem.id }}">
								<div class="card">
									<img src="{{path('imagem',{'path':'empreendimentos_galeria',imagem:imagem.imagem})}}" 
										 class="card-img-top" 
										 style="height: 150px; object-fit: cover; cursor: pointer;"
										 alt="{{ imagem.titulo }}"
										 data-toggle="modal" 
										 data-target="#imageModal"
										 data-src="{{path('imagem',{'path':'empreendimentos_galeria',imagem:imagem.imagem})}}">
									<div class="card-body p-2">
										<p class="card-text small mb-1">
											<strong>{{ imagem.titulo }}</strong>
										</p>
										<p class="card-text small text-muted mb-2">
											Tipo: {{ imagem.tipo|capitalize }}
										</p>
										<button type="button" 
												class="btn btn-danger btn-sm btn-block btn-mark-remove" 
												data-image-id="{{ imagem.id }}"
												data-titulo="{{ imagem.titulo }}">
											<i class="fas fa-trash"></i> Remover
										</button>
									</div>
								</div>
							</div>
							{% endfor %}
						</div>
					</div>
					{% endif %}
				</div>
			</div>
		</div>

		<!-- Modal para visualizar imagem -->
		<div class="modal fade" id="imageModal" tabindex="-1">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Visualizar Imagem</h5>
						<button type="button" class="close" data-dismiss="modal">
							<span>&times;</span>
						</button>
					</div>
					<div class="modal-body text-center">
						<img id="modalImage" src="" class="img-fluid" alt="Imagem">
					</div>
				</div>
			</div>
		</div>

			<!-- SE√á√ÉO: BENEF√çCIOS DO EMPREENDIMENTO -->
			<div class="card card-success">
				<div class="card-header">
					<h3 class="card-title">
						<i class="fas fa-star"></i>
						Benef√≠cios do Empreendimento
					</h3>
					<div class="card-tools">
						<button type="button" class="btn btn-tool" data-card-widget="collapse">
							<i class="fas fa-minus"></i>
						</button>
					</div>
				</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-8">
							<!-- Formul√°rio para adicionar benef√≠cio -->
							<div class="border p-3 mb-3" style="border-radius: 8px; background-color: #f8f9fa;">
								<h5><i class="fas fa-plus-circle text-success"></i> Adicionar Benef√≠cio</h5>
								<div class="row">
									<div class="col-md-6">
										<div class="form-group">
											<label for="beneficio_select">Benef√≠cio</label>
											<select id="beneficio_select" class="form-control">
												<option value="">Selecione um benef√≠cio...</option>
												{% for beneficio in beneficios_disponiveis %}
													<option value="{{ beneficio.id }}" data-titulo="{{ beneficio.titulo }}" data-svg="{{ beneficio.svg_code|e('html_attr') }}">
														{{ beneficio.titulo }}
													</option>
												{% endfor %}
											</select>
										</div>
									</div>
									<div class="col-md-6">
										<div class="form-group">
											<label for="valor_personalizado">Valor Personalizado</label>
											<input type="text" id="valor_personalizado" class="form-control" maxlength="120" placeholder="Ex: A partir de R$ 250.000">
											<small class="form-text text-muted">M√°ximo 120 caracteres</small>
										</div>
									</div>
								</div>
								<div class="row">
									<div class="col-md-6">
										<div class="form-group">
											<label for="cor_beneficio">Cor do √çcone</label>
											<div class="row">
												<div class="col-6">
													<input type="color" id="cor_beneficio" class="form-control" value="#000000" title="Seletor de cor">
												</div>
												<div class="col-6">
													<div class="input-group">
														<div class="input-group-prepend">
															<span class="input-group-text">#</span>
														</div>
														<input type="text" id="cor_hex_input" class="form-control" value="000000" 
															   maxlength="6" placeholder="000000" 
															   pattern="[0-9A-Fa-f]{6}" 
															   title="Digite o c√≥digo hexadecimal (6 caracteres)">
													</div>
												</div>
											</div>
											<small class="form-text text-muted">Use o seletor de cor ou digite o c√≥digo hexadecimal</small>
										</div>
									</div>
									<div class="col-md-6">
										<div class="form-group">
											<label>&nbsp;</label>
											<div>
												<button type="button" id="btn_adicionar_beneficio" class="btn btn-success btn-block">
													<i class="fas fa-plus"></i> Adicionar Benef√≠cio
												</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<!-- Preview do benef√≠cio selecionado -->
							<div class="border p-3" style="border-radius: 8px; background-color: #e9ecef;">
								<h6><i class="fas fa-eye"></i> Preview</h6>
								<div id="beneficio_preview" class="text-center" style="min-height: 100px; display: flex; align-items: center; justify-content: center;">
									<span class="text-muted">
										<i class="fas fa-star fa-2x"></i>
										<br><small>Selecione um benef√≠cio</small>
									</span>
								</div>
							</div>
						</div>
					</div>

					<!-- Lista de benef√≠cios adicionados -->
					<div class="mt-4">
						<h5><i class="fas fa-list"></i> Benef√≠cios Adicionados</h5>
						<div id="beneficios_lista" class="row">
							<!-- Benef√≠cios existentes (em edi√ß√£o) -->
							{% if beneficios_selecionados is defined and beneficios_selecionados|length > 0 %}
								{% for beneficio in beneficios_selecionados %}
									<div class="col-md-6 mb-3 beneficio-item" data-id="{{ beneficio.id }}">
										<div class="card">
											<div class="card-body p-3">
												<div class="row align-items-center">
													<div class="col-2 text-center">
														<div style="width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; color: {{ beneficio.cor_hex }};">
															{{ beneficio.svg_code|raw }}
														</div>
													</div>
													<div class="col-7">
														<h6 class="mb-1">{{ beneficio.titulo }}</h6>
														{% if beneficio.valor_personalizado %}
															<small class="text-muted">{{ beneficio.valor_personalizado }}</small>
														{% endif %}
													</div>
													<div class="col-3 text-right">
														<button type="button" class="btn btn-sm btn-danger btn-remover-beneficio" data-id="{{ beneficio.id }}">
															<i class="fas fa-times"></i>
														</button>
													</div>
												</div>
											</div>
										</div>
									</div>
								{% endfor %}
							{% endif %}
						</div>
						<div id="beneficios_empty" class="text-center text-muted" {% if beneficios_selecionados is defined and beneficios_selecionados|length > 0 %}style="display: none;"{% endif %}>
							<i class="fas fa-info-circle fa-2x mb-3"></i>
							<br>Nenhum benef√≠cio adicionado ainda
						</div>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-md-12">
					<div class="card">
						<div class="card-footer">
							<button type="submit" class="btn btn-info float-right">{{ btn_acao }}</button>
							<a href="{{ path('s_empreendimentos') }}" class="btn btn-default float-left">Voltar</a>
						</div>
					</div>
				</div>
			</div>

			{{ form_end(form) }}
		</div>
	</section>
	<!-- END Main content -->
{% endblock content %}

{% block script %}
	{{ parent() }}
	<script src="{{ asset('plugins/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
	<script src="{{ asset('dist/js/adminlte.min.js') }}"></script>
	<script src="{{ asset('plugins/summernote/summernote-bs4.min.js') }}"></script>
	<script src="{{ asset('plugins/select2/js/select2.full.min.js') }}"></script>

	<script>
		$(function () { // Summernote
$('.editor-content').summernote({
height: 200,
toolbar: [
[
'style', ['style']
],
[
'font',
[
'bold', 'italic', 'underline', 'clear'
]
],
[
'color', ['color']
],
[
'para',
[
'ul', 'ol', 'paragraph'
]
],
[
'table', ['table']
],
[
'insert',
[
'link', 'picture', 'video'
]
],
[
'view',
[
'fullscreen', 'codeview', 'help'
]
]
]
});

// Select2
$('.select2').select2({theme: 'bootstrap4'});

// Auto-generate slug from nome
$('#empreendimentos_nome').on('input', function () {
var nome = $(this).val();
var slug = nome.toLowerCase().replace(/[√°√†√£√§√¢]/g, 'a').replace(/[√©√®√´√™]/g, 'e').replace(/[√≠√¨√Ø√Æ]/g, 'i').replace(/[√≥√≤√µ√∂√¥]/g, 'o').replace(/[√∫√π√º√ª]/g, 'u').replace(/[√ß]/g, 'c').replace(/[√±]/g, 'n').replace(/[^a-z0-9 ]/g, '').replace(/\s+/g, '-').replace(/^-+|-+$/g, '');

if ($('#empreendimentos_slug').val() === '' || $('#empreendimentos_slug').data('auto-generated')) {
$('#empreendimentos_slug').val(slug).data('auto-generated', true);
}
});

// Stop auto-generation if user manually edits slug
$('#empreendimentos_slug').on('input', function () {
$(this).data('auto-generated', false);
});

// Character counters for SEO fields
function updateCharCount(fieldId, counterId, maxLength) {
var $field = $('#' + fieldId);
var $counter = $('#' + counterId);

function updateCount() {
var length = $field.val().length;
$counter.text(length);

if (length > maxLength) {
$counter.addClass('text-danger');
} else if (length > maxLength * 0.8) {
$counter.removeClass('text-danger').addClass('text-warning');
} else {
$counter.removeClass('text-danger text-warning');
}
}

$field.on('input', updateCount);
updateCount(); // Initial count
}

updateCharCount('empreendimentos_meta_title', 'meta-title-count', 160);
updateCharCount('empreendimentos_meta_description', 'meta-desc-count', 255);

// ==============================================
// VERS√ÉO SIMPLIFICADA PARA DEBUG
// ==============================================

console.log('üöÄ Iniciando sistema de galeria SIMPLIFICADO...');

// Array para controlar as imagens selecionadas
var galeriaFiles = [];

$(document).ready(function() {
	// Aguardar um pouco para garantir que o DOM est√° pronto
	setTimeout(function() {
		console.log('üîç Procurando campo de galeria...');
		
		// Tentar m√∫ltiplos seletores
		var field = null;
		var selectors = [
			'#galeria_imagens_input',
			'#empreendimentos_galeria_imagens',
			'input[name*="galeria_imagens"]',
			'input[name="empreendimentos[galeria_imagens][]"]',
			'input[name="empreendimentos[galeria_imagens]"]'
		];
		
		for (var i = 0; i < selectors.length; i++) {
			field = $(selectors[i]);
			console.log('üéØ Testando seletor "' + selectors[i] + '":', field.length > 0);
			if (field.length > 0) {
				console.log('‚úÖ Campo encontrado com seletor:', selectors[i]);
				console.log('üìù Nome do campo:', field.attr('name'));
				console.log('üÜî ID do campo:', field.attr('id'));
				break;
			}
		}
		
		if (field && field.length > 0) {
			// Garantir que tem ID
			if (!field.attr('id')) {
				field.attr('id', 'galeria_imagens_input');
				console.log('üîß ID adicionado ao campo');
			}
			
			// Adicionar instru√ß√µes visuais
			$('#galeria_imagens_input').after(
				'<div class="text-muted small mt-2">' +
				'<i class="fas fa-lightbulb"></i> <strong>Dicas:</strong><br>' +
				'‚Ä¢ Voc√™ pode arrastar e soltar imagens diretamente na √°rea acima<br>' +
				'‚Ä¢ Selecione m√∫ltiplas imagens segurando Ctrl e clicando<br>' +
				'‚Ä¢ Para muitas imagens grandes, reduza a qualidade antes do upload<br>' +
				'‚Ä¢ As imagens ser√£o salvas apenas quando voc√™ clicar em "Salvar"' +
				'</div>'
			);

			// Evento de sele√ß√£o de arquivos
			field.on('change', function(e) {
				console.log('üî• FUNCIONOU! Arquivo selecionado!');
				console.log('üìÅ N√∫mero de arquivos:', e.target.files.length);
				
				// VALIDA√á√ïES ANTES DE PROCESSAR
				var totalSize = 0;
				var invalidFiles = [];
				var oversizedFiles = [];
				var maxFileSize = 10 * 1024 * 1024; // 10MB
				var maxTotalSize = 80 * 1024 * 1024; // 80MB (deixar margem)
				var maxFiles = 20;
				
				// Verificar limite de arquivos
				if (e.target.files.length > maxFiles) {
					alert('‚ö†Ô∏è M√°ximo de ' + maxFiles + ' arquivos permitidos. Voc√™ selecionou ' + e.target.files.length + ' arquivos.');
					return;
				}
				
				// Adicionar novos arquivos ao array (sem duplicar)
				for (var i = 0; i < e.target.files.length; i++) {
					var file = e.target.files[i];
					
					// Validar tipo
					if (!file.type.startsWith('image/')) {
						invalidFiles.push(file.name);
						continue;
					}
					
					// Validar tamanho individual
					if (file.size > maxFileSize) {
						oversizedFiles.push(file.name + ' (' + (file.size / 1024 / 1024).toFixed(1) + 'MB)');
						continue;
					}
					
					totalSize += file.size;
					
					// Criar objeto √∫nico para cada arquivo
					var fileObj = {
						file: file,
						id: 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
						name: file.name,
						size: file.size
					};
					galeriaFiles.push(fileObj);
					console.log('üìÑ Arquivo adicionado:', file.name);
				}
				
				// Mostrar avisos se necess√°rio
				if (invalidFiles.length > 0) {
					alert('‚ö†Ô∏è Arquivos inv√°lidos (apenas imagens s√£o aceitas):\n‚Ä¢ ' + invalidFiles.join('\n‚Ä¢ '));
				}
				
				if (oversizedFiles.length > 0) {
					alert('‚ö†Ô∏è Arquivos muito grandes (m√°ximo 10MB cada):\n‚Ä¢ ' + oversizedFiles.join('\n‚Ä¢ '));
				}
				
				// Verificar tamanho total
				if (totalSize > maxTotalSize) {
					alert('‚ö†Ô∏è Tamanho total muito grande!\nTotal: ' + (totalSize / 1024 / 1024).toFixed(1) + 'MB\nM√°ximo permitido: ' + (maxTotalSize / 1024 / 1024) + 'MB\n\nRemova algumas imagens ou reduza a qualidade.');
					// Limpar sele√ß√£o se exceder limite
					galeriaFiles = [];
				}
				
				// Atualizar preview
				updateGaleriaPreview();
				updateFileInput();
			});
			
			console.log('‚úÖ Evento de mudan√ßa anexado com sucesso');
			
		} else {
			console.error('‚ùå NENHUM CAMPO DE GALERIA ENCONTRADO!');
			console.log('üîç Listando todos os campos file na p√°gina:');
			$('input[type="file"]').each(function() {
				console.log('üìÅ Campo file:', $(this).attr('name'), $(this).attr('id'));
			});
		}
		
	}, 500);
});

// Atualizar preview da galeria
function updateGaleriaPreview() {
	var container = $('#preview-images');
	container.empty();
	
	if (galeriaFiles.length > 0) {
		$('#preview-container').show();
		
		galeriaFiles.forEach(function(fileObj, index) {
			var reader = new FileReader();
			reader.onload = function(e) {
				var preview = $(`
					<div class="col-md-3 col-sm-6 mb-3" data-file-id="${fileObj.id}">
						<div class="card">
							<div class="position-relative">
								<img src="${e.target.result}" 
									 class="card-img-top" 
									 style="height:150px;object-fit:cover;" 
									 alt="${fileObj.name}">
								<button type="button" 
										class="btn btn-danger btn-sm position-absolute btn-remove-image" 
										data-file-id="${fileObj.id}"
										style="top: 5px; right: 5px; padding: 2px 6px;">
									<i class="fas fa-trash"></i>
								</button>
							</div>
							<div class="card-body p-2">
								<p class="card-text small mb-1">
									<strong>${fileObj.name}</strong>
								</p>
								<p class="card-text small text-muted mb-0">
									${(fileObj.size / 1024 / 1024).toFixed(2)} MB
								</p>
							</div>
						</div>
					</div>
				`);
				container.append(preview);
			};
			reader.readAsDataURL(fileObj.file);
		});
		
		// Atualizar contador
		$('#preview-container h6').html(
			'<i class="fas fa-eye"></i> Pr√©via das novas imagens: <span class="badge badge-info">' + galeriaFiles.length + '</span>'
		);
	} else {
		$('#preview-container').hide();
	}
}

// Atualizar o input file com as imagens restantes
function updateFileInput() {
	var dt = new DataTransfer();
	
	galeriaFiles.forEach(function(fileObj) {
		dt.items.add(fileObj.file);
	});
	
	var inputElement = document.getElementById('galeria_imagens_input') || 
					   document.querySelector('input[name*="galeria_imagens"]');
	
	if (inputElement) {
		inputElement.files = dt.files;
		console.log('‚úÖ Input atualizado com', dt.files.length, 'arquivos');
	}
}

// Evento para remover imagem individual
$(document).on('click', '.btn-remove-image', function(e) {
	e.preventDefault();
	var fileId = $(this).data('file-id');
	var fileName = $(this).closest('.card').find('strong').text();
	
	if (confirm('Remover a imagem "' + fileName + '"?')) {
		console.log('üóëÔ∏è Removendo imagem:', fileName);
		
		// Remover do array
		galeriaFiles = galeriaFiles.filter(function(fileObj) {
			return fileObj.id !== fileId;
		});
		
		// Remover do DOM com anima√ß√£o
		$('[data-file-id="' + fileId + '"]').fadeOut(300, function() {
			$(this).remove();
			
			// Atualizar input e preview
			updateFileInput();
			
			// Atualizar contador ou ocultar se vazio
			if (galeriaFiles.length === 0) {
				$('#preview-container').hide();
			} else {
				$('#preview-container h6').html(
					'<i class="fas fa-eye"></i> Pr√©via das novas imagens: <span class="badge badge-info">' + galeriaFiles.length + '</span>'
				);
			}
		});
	}
});

	// ==============================================
	// SISTEMA DE REMO√á√ÉO AJAX - IMAGENS EXISTENTES
	// ==============================================

	$(document).on('click', '.btn-mark-remove', function(e) {
		e.preventDefault();
		
		var $btn = $(this);
		
		// ‚úÖ PEGAR VALOR DIRETAMENTE DO HTML E CONVERTER PARA INT
		var imageIdRaw = $btn.attr('data-image-id');
		var imageId = parseInt(imageIdRaw, 10);
		var imageTitle = $btn.data('titulo');
		var $galeriaItem = $('#galeria-item-' + imageId);
		
		// Debug completo
		console.log('üîç DEBUG COMPLETO:');
		console.log('- Valor HTML bruto:', imageIdRaw);
		console.log('- Image ID convertido:', imageId);
		console.log('- Image ID tipo:', typeof imageId);
		console.log('- √â n√∫mero v√°lido:', !isNaN(imageId));
		console.log('- √â maior que 0:', imageId > 0);
		
		// ‚úÖ VALIDA√á√ÉO ROBUSTA COM INT
		if (isNaN(imageId) || imageId <= 0) {
			alert('‚ùå Erro: ID da imagem inv√°lido (NaN ou <= 0). Valor: ' + imageIdRaw);
			return;
		}
		
		console.log('‚úÖ VALIDA√á√ÉO PASSOU! ImageId v√°lido:', imageId);
		
		// Confirma√ß√£o com nome da imagem
		var confirmMsg = 'Tem certeza que deseja remover a imagem "' + imageTitle + '"?\n\n' +
						'‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!';
		
		if (!confirm(confirmMsg)) {
			return;
		}
		
		// Feedback visual - bot√£o loading
		$btn.prop('disabled', true);
		$btn.html('<i class="fas fa-spinner fa-spin"></i> Removendo...');
		$galeriaItem.addClass('removing').css('opacity', '0.5');
		
		// ‚úÖ DEBUG DETALHADO PARA ID DO EMPREENDIMENTO
		
		
		// Tentar m√∫ltiplas formas de pegar o ID
		var empId1 = $('input[name="empreendimentos[id]"]').val();
		var empId2 = $('input[name="id"]').val();
		var empId3 = getEmpreendimentoIdFromUrl();
		
		
		
		// Listar todos os inputs que podem conter ID
		
		$('input[name*="id"]').each(function() {
			console.log('  * Nome:', $(this).attr('name'), 'Valor:', $(this).val());
		});
		
		// Tentar ID do empreendimento
		var empreendimentoId = empId1 || empId2 || empId3;
		
		
		
		if (!empreendimentoId) {
			alert('‚ùå Erro: ID do empreendimento n√£o encontrado\n\nVerifique o console para mais detalhes');
			resetButton();
			return;
		}
		
		// Converter para int se necess√°rio
		empreendimentoId = parseInt(empreendimentoId, 10);
		if (isNaN(empreendimentoId) || empreendimentoId <= 0) {
			alert('‚ùå Erro: ID do empreendimento inv√°lido: ' + empreendimentoId);
			resetButton();
			return;
		}
		
		console.log('üóëÔ∏è Removendo imagem ID:', imageId, 'do empreendimento:', empreendimentoId);
		
		// Chamar endpoint AJAX
		$.ajax({
			url: '{{ path("s_empreendimentos_remove_galeria_image") }}',
			type: 'POST',
			data: {
				image_id: imageId,
				empreendimento_id: empreendimentoId
			},
			dataType: 'json',
			success: function(response) {
				console.log('‚úÖ Resposta do servidor:', response);
				
				if (response.success) {
					// Sucesso - remover com anima√ß√£o
					$galeriaItem.fadeOut(400, function() {
						$(this).remove();
						
						// Atualizar contador de imagens
						updateImageCount();
						
						// Mostrar notifica√ß√£o de sucesso
						showNotification('success', response.message || 'Imagem removida com sucesso!');
					});
				} else {
					// Erro do servidor
					alert('‚ùå Erro: ' + (response.message || 'Falha ao remover imagem'));
					resetButton();
				}
			},
			error: function(xhr, status, error) {
				console.error('‚ùå Erro AJAX:', {xhr: xhr, status: status, error: error});
				
				var errorMsg = 'Erro de conex√£o ao remover imagem';
				if (xhr.responseJSON && xhr.responseJSON.message) {
					errorMsg = xhr.responseJSON.message;
				}
				
				alert('‚ùå ' + errorMsg);
				resetButton();
			}
		});
		
		function resetButton() {
			$btn.prop('disabled', false);
			$btn.html('<i class="fas fa-trash"></i> Remover');
			$galeriaItem.removeClass('removing').css('opacity', '1');
		}
	});
	
	// Fun√ß√£o auxiliar para pegar ID do empreendimento da URL
	function getEmpreendimentoIdFromUrl() {
		var url = window.location.pathname;
		console.log('  üîç Analisando URL:', url);
		
		// Tentar diferentes padr√µes de URL
		var patterns = [
			/empreendimentos\/(\d+)/,           // /empreendimentos/123
			/empreendimentos\/edit\/(\d+)/,     // /empreendimentos/edit/123
			/empreendimentos\/(\d+)\/edit/,     // /empreendimentos/123/edit
			/\/(\d+)\/edit$/,                   // qualquer coisa que termine com /123/edit
			/\/(\d+)$/                          // qualquer coisa que termine com /123
		];
		
		for (var i = 0; i < patterns.length; i++) {
			var match = url.match(patterns[i]);
			if (match) {
				console.log('  ‚úÖ URL match encontrado com padr√£o', i + 1, ':', match[1]);
				return match[1];
			}
		}
		
		console.log('  ‚ùå Nenhum padr√£o de URL matched');
		return null;
	}
	
	// Fun√ß√£o para atualizar contador de imagens
	function updateImageCount() {
		var $container = $('.row').has('[id^="galeria-item-"]');
		var remainingImages = $container.find('[id^="galeria-item-"]:visible').length;
		
		var $header = $container.closest('.mt-4').find('h6');
		if ($header.length) {
			if (remainingImages > 0) {
				$header.html('<i class="fas fa-folder-open"></i> Imagens atuais na galeria (' + remainingImages + '):');
			} else {
				$header.html('<i class="fas fa-folder-open"></i> Nenhuma imagem na galeria');
				$container.append('<div class="col-12 text-center text-muted p-4"><i class="fas fa-images fa-3x mb-3"></i><br>Nenhuma imagem na galeria</div>');
			}
		}
	}
	
	// Fun√ß√£o para mostrar notifica√ß√µes
	function showNotification(type, message) {
		var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
		var icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
		
		var $notification = $(`
			<div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
				 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
				<i class="${icon}"></i> ${message}
				<button type="button" class="close" data-dismiss="alert">
					<span>&times;</span>
				</button>
			</div>
		`);
		
		$('body').append($notification);
		
		// Auto-remover ap√≥s 5 segundos
		setTimeout(function() {
			$notification.fadeOut(function() {
				$(this).remove();
			});
		}, 5000);
	}

// Backup dos arrays originais
var selectedImages = [];
var imagesToRemove = [];

	// ========================================
	// GEST√ÉO DE BENEF√çCIOS
	// ========================================

	// Preview do benef√≠cio selecionado
	$('#beneficio_select').on('change', function() {
		var selectedOption = $(this).find('option:selected');
		var preview = $('#beneficio_preview');
		var cor = $('#cor_beneficio').val();
		
		if (selectedOption.val()) {
			var titulo = selectedOption.data('titulo');
			var svgCode = selectedOption.data('svg');
			
			var previewHtml = '<div style="color: ' + cor + ';">' + svgCode + '</div>';
			previewHtml += '<h6 class="mt-2">' + titulo + '</h6>';
			
			var valor = $('#valor_personalizado').val();
			if (valor) {
				previewHtml += '<small class="text-muted">' + valor + '</small>';
			}
			
			preview.html(previewHtml);
		} else {
			preview.html('<span class="text-muted"><i class="fas fa-star fa-2x"></i><br><small>Selecione um benef√≠cio</small></span>');
		}
	});

	// Atualizar preview quando cor ou valor mudar
	$('#cor_beneficio, #cor_hex_input, #valor_personalizado').on('change input', function() {
		$('#beneficio_select').trigger('change');
	});

	// Sincronizar color picker com input hex
	$('#cor_beneficio').on('change input', function() {
		var color = $(this).val();
		var hex = color.replace('#', '').toUpperCase();
		$('#cor_hex_input').val(hex);
	});

	// Sincronizar input hex com color picker
	$('#cor_hex_input').on('input', function() {
		var hex = $(this).val().replace('#', '');
		
		// Validar se √© um hex v√°lido (6 caracteres hexadecimais)
		if (/^[0-9A-Fa-f]{6}$/.test(hex)) {
			$(this).removeClass('is-invalid').addClass('is-valid');
			$('#cor_beneficio').val('#' + hex);
		} else if (hex.length === 0) {
			$(this).removeClass('is-invalid is-valid');
		} else {
			$(this).removeClass('is-valid').addClass('is-invalid');
		}
	});

	// Valida√ß√£o adicional no blur para garantir formato correto
	$('#cor_hex_input').on('blur', function() {
		var hex = $(this).val().replace('#', '');
		
		if (hex.length > 0) {
			// Se n√£o for v√°lido, reverter para a cor atual do color picker
			if (!/^[0-9A-Fa-f]{6}$/.test(hex)) {
				var currentColor = $('#cor_beneficio').val();
				var currentHex = currentColor.replace('#', '').toUpperCase();
				$(this).val(currentHex);
				$(this).removeClass('is-invalid').addClass('is-valid');
			} else {
				// Padronizar para mai√∫sculo
				$(this).val(hex.toUpperCase());
				$(this).removeClass('is-invalid').addClass('is-valid');
			}
		}
	});

	// Fun√ß√£o para obter ID do empreendimento
	function getEmpreendimentoId() {
		{% if empreendimento_id %}
			return {{ empreendimento_id }};
		{% else %}
			return null;
		{% endif %}
	}

	// Adicionar benef√≠cio
	$('#btn_adicionar_beneficio').on('click', function() {
		var btn = $(this);
		var beneficioId = $('#beneficio_select').val();
		var valorPersonalizado = $('#valor_personalizado').val();
		var corHex = $('#cor_beneficio').val();
		var empreendimentoId = getEmpreendimentoId();

		// Valida√ß√µes
		if (!beneficioId) {
			alert('Por favor, selecione um benef√≠cio.');
			return;
		}

		if (!empreendimentoId) {
			alert('Este empreendimento precisa ser salvo antes de adicionar benef√≠cios.');
			return;
		}

		// Verificar se j√° existe
		var existente = $('#beneficios_lista').find('[data-beneficio-id="' + beneficioId + '"]');
		if (existente.length > 0) {
			alert('Este benef√≠cio j√° foi adicionado ao empreendimento.');
			return;
		}

		// Desabilitar bot√£o
		btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Adicionando...');

		// Requisi√ß√£o AJAX
		$.ajax({
			url: '{{ path('s_empreendimentos_adicionar_beneficio') }}',
			method: 'POST',
			data: {
				empreendimento_id: empreendimentoId,
				beneficio_id: beneficioId,
				valor_personalizado: valorPersonalizado,
				cor_hex: corHex
			},
			dataType: 'json',
			success: function(response) {
				if (response.success) {
					// Adicionar √† lista
					adicionarBeneficioLista(response.data);
					
					// Limpar formul√°rio
					limparFormularioBeneficio();
					
					// Mostrar sucesso
					showNotification('success', response.message);
				} else {
					alert('Erro: ' + response.message);
				}
			},
			error: function(xhr, status, error) {
				console.error('Erro AJAX:', error);
				alert('Erro ao adicionar benef√≠cio. Tente novamente.');
			},
			complete: function() {
				// Reabilitar bot√£o
				btn.prop('disabled', false).html('<i class="fas fa-plus"></i> Adicionar Benef√≠cio');
			}
		});
	});

	// Fun√ß√£o para adicionar benef√≠cio √† lista
	function adicionarBeneficioLista(data) {
		var html = '<div class="col-md-6 mb-3 beneficio-item" data-id="' + data.id + '" data-beneficio-id="' + data.beneficio_id + '">';
		html += '<div class="card">';
		html += '<div class="card-body p-3">';
		html += '<div class="row align-items-center">';
		html += '<div class="col-2 text-center">';
		html += '<div style="width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; color: ' + data.cor_hex + ';">';
		html += data.svg_code;
		html += '</div>';
		html += '</div>';
		html += '<div class="col-7">';
		html += '<h6 class="mb-1">' + data.titulo + '</h6>';
		if (data.valor_personalizado) {
			html += '<small class="text-muted">' + data.valor_personalizado + '</small>';
		}
		html += '</div>';
		html += '<div class="col-3 text-right">';
		html += '<button type="button" class="btn btn-sm btn-danger btn-remover-beneficio" data-id="' + data.id + '">';
		html += '<i class="fas fa-times"></i>';
		html += '</button>';
		html += '</div>';
		html += '</div>';
		html += '</div>';
		html += '</div>';
		html += '</div>';

		$('#beneficios_lista').append(html);
		$('#beneficios_empty').hide();
	}

	// Fun√ß√£o para limpar formul√°rio
	function limparFormularioBeneficio() {
		$('#beneficio_select').val('').trigger('change');
		$('#valor_personalizado').val('');
		$('#cor_beneficio').val('#000000');
		$('#cor_hex_input').val('000000').removeClass('is-invalid is-valid');
		$('#beneficio_preview').html('<span class="text-muted"><i class="fas fa-star fa-2x"></i><br><small>Selecione um benef√≠cio</small></span>');
	}

	// Remover benef√≠cio (delega√ß√£o de eventos)
	$(document).on('click', '.btn-remover-beneficio', function() {
		var btn = $(this);
		var id = btn.data('id');
		var beneficioItem = btn.closest('.beneficio-item');

		if (!confirm('Tem certeza que deseja remover este benef√≠cio?')) {
			return;
		}

		// Desabilitar bot√£o
		btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

		// Requisi√ß√£o AJAX
		$.ajax({
			url: '{{ path('s_empreendimentos_remover_beneficio') }}',
			method: 'POST',
			data: {
				id: id
			},
			dataType: 'json',
			success: function(response) {
				if (response.success) {
					// Remover da lista com anima√ß√£o
					beneficioItem.fadeOut(400, function() {
						$(this).remove();
						
						// Verificar se lista ficou vazia
						if ($('#beneficios_lista .beneficio-item').length === 0) {
							$('#beneficios_empty').show();
						}
					});
					
					// Mostrar sucesso
					showNotification('success', response.message);
				} else {
					alert('Erro: ' + response.message);
					btn.prop('disabled', false).html('<i class="fas fa-times"></i>');
				}
			},
			error: function(xhr, status, error) {
				console.error('Erro AJAX:', error);
				alert('Erro ao remover benef√≠cio. Tente novamente.');
				btn.prop('disabled', false).html('<i class="fas fa-times"></i>');
			}
		});
	});

	// Fun√ß√£o auxiliar para mostrar notifica√ß√µes
	function showNotification(type, message) {
		var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
		var iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
		
		var notification = $('<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
			'<i class="fas ' + iconClass + '"></i> ' + message +
			'<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
			'<span aria-hidden="true">&times;</span>' +
			'</button>' +
			'</div>');
		
		$('body').append(notification);
		
		// Auto-remover ap√≥s 5 segundos
		setTimeout(function() {
			notification.alert('close');
		}, 5000);
	}

	}); // Fechamento da fun√ß√£o principal $(function () {
	</script>
{% endblock script %}
